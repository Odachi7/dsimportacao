<Window x:Class="DSI.Desktop.Views.JobWizardWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:DSI.Desktop.ViewModels"
        xmlns:local="clr-namespace:DSI.Desktop.Views"
        Title="Novo Job ETL - Wizard" 
        Height="700" Width="1000"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BackgroundBrush}">
    

    
    <Window.Resources>
        <!-- Converter para mostrar/ocultar passos -->
        <local:PassoVisibilityConverter x:Key="PassoVisibilityConverter"/>
        <local:EqualConverter x:Key="EqualConverter"/>
        <local:NotEqualConverter x:Key="NotEqualConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Cabeçalho com Indicador de Passos -->
        <Border Grid.Row="0" Background="{StaticResource PrimaryBrush}" Padding="30,20">
            <StackPanel>
                <TextBlock Text="Criar Novo Job ETL" FontSize="28" FontWeight="Bold" Foreground="White"/>
                <StackPanel Orientation="Horizontal" Margin="0,15,0,0">
                    <!-- Indicadores de Passo -->
                    <Border Width="40" Height="40" CornerRadius="20" Background="{StaticResource SurfaceBrush}" Margin="0,0,10,0">
                        <TextBlock Text="1" FontSize="18" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    <TextBlock Text="→" FontSize="20" Foreground="White" Margin="5,0"/>
                    
                    <Border Width="40" Height="40" CornerRadius="20" Background="White" Opacity="0.5" Margin="0,0,10,0">
                        <TextBlock Text="2" FontSize="18" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    <TextBlock Text="→" FontSize="20" Foreground="White" Margin="5,0"/>
                    
                    <Border Width="40" Height="40" CornerRadius="20" Background="White" Opacity="0.5" Margin="0,0,10,0">
                        <TextBlock Text="3" FontSize="18" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    <TextBlock Text="..." FontSize="20" Foreground="White" Margin="10,0"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Conteúdo dos Passos -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <Border Margin="40" Background="{StaticResource SurfaceBrush}" CornerRadius="8" Padding="40">
                <StackPanel>
                    <!-- Passo 1: Informações Básicas -->
                    <StackPanel Visibility="{Binding PassoAtual, Converter={StaticResource PassoVisibilityConverter}, ConverterParameter=1}">
                        <TextBlock Text="Passo 1: Informações Básicas" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>
                        
                        <TextBlock Text="Nome do Job *" FontWeight="SemiBold" Margin="0,10,0,5"/>
                        <TextBox Text="{Binding NomeJob, UpdateSourceTrigger=PropertyChanged}" />
                        
                        <TextBlock Text="Descrição (Opcional)" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <TextBox Text="{Binding DescricaoJob, UpdateSourceTrigger=PropertyChanged}" 
                                 Height="80" TextWrapping="Wrap" AcceptsReturn="True"
                                 VerticalScrollBarVisibility="Auto"/>
                        
                        <CheckBox Content="Job Ativo" IsChecked="{Binding JobAtivo}" Margin="0,20,0,0" FontSize="14"/>
                    </StackPanel>

                    <!-- Passo 2: Conexões -->
                    <StackPanel Visibility="{Binding PassoAtual, Converter={StaticResource PassoVisibilityConverter}, ConverterParameter=2}">
                        <TextBlock Text="Passo 2: Selecionar Conexões" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>
                        
                        <TextBlock Text="Conexão de Origem *" FontWeight="SemiBold" Margin="0,10,0,5"/>
                        <ComboBox ItemsSource="{Binding ConexoesDisponiveis}"
                                  SelectedItem="{Binding ConexaoOrigemSelecionada}"
                                  DisplayMemberPath="Nome"
                                  Height="40"/>
                        
                        <TextBlock Text="Conexão de Destino *" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <ComboBox ItemsSource="{Binding ConexoesDisponiveis}"
                                  SelectedItem="{Binding ConexaoDestinoSelecionada}"
                                  DisplayMemberPath="Nome"
                                  Height="40"/>

                        <TextBlock Text="As conexões devem ser diferentes" 
                                   FontStyle="Italic" Foreground="Gray" Margin="0,10,0,0"/>
                    </StackPanel>

                    <!-- Passo 3: Configurações ETL -->
                    <StackPanel Visibility="{Binding PassoAtual, Converter={StaticResource PassoVisibilityConverter}, ConverterParameter=3}">
                        <TextBlock Text="Passo 3: Configurações ETL" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>
                        
                        <TextBlock Text="Modo de Execução *" FontWeight="SemiBold" Margin="0,10,0,5"/>
                        <ComboBox ItemsSource="{Binding ModosDisponiveis}"
                                  SelectedItem="{Binding ModoSelecionado}"
                                  Height="40"/>
                        
                        <TextBlock Text="Tamanho do Lote *" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <TextBox Text="{Binding TamanhoLote, UpdateSourceTrigger=PropertyChanged}"/>
                        <TextBlock Text="Número de registros processados por vez (1-10000)" 
                                   FontStyle="Italic" Foreground="Gray" Margin="0,5,0,0" FontSize="12"/>
                        
                        <TextBlock Text="Política de Erro *" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <ComboBox ItemsSource="{Binding PoliticasErroDisponiveis}"
                                  SelectedItem="{Binding PoliticaErroSelecionada}"
                                  Height="40"/>
                        
                        <TextBlock Text="Estratégia de Conflito *" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <ComboBox ItemsSource="{Binding EstrategiasConflitoDisponiveis}"
                                  SelectedItem="{Binding EstrategiaConflitoSelecionada}"
                                  Height="40"/>
                    </StackPanel>

                    <!-- Passos 4-7 Placeholders -->
                    <StackPanel Visibility="{Binding PassoAtual, Converter={StaticResource PassoVisibilityConverter}, ConverterParameter=4}">
                        <TextBlock Text="Passo 4: Selecionar Tabelas" FontSize="24" FontWeight="Bold" Margin="0,0,0,10"/>
                        
                        <Grid Height="400">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <ProgressBar IsIndeterminate="True" Height="4" 
                                         Visibility="{Binding CarregandoTabelas, Converter={StaticResource BooleanToVisibilityConverter}}"
                                         VerticalAlignment="Top"/>
                            
                            <DataGrid Grid.Row="1" ItemsSource="{Binding TabelasDisponiveis}" 
                                      AutoGenerateColumns="False" CanUserAddRows="False"
                                      HeadersVisibility="Column" GridLinesVisibility="Horizontal"
                                      BorderThickness="1" BorderBrush="#DDDDDD">
                                <DataGrid.Columns>
                                    <DataGridCheckBoxColumn Binding="{Binding Selecionada, UpdateSourceTrigger=PropertyChanged}" 
                                                            Header="Sel." Width="50"/>
                                    <DataGridTextColumn Binding="{Binding Nome}" Header="Nome da Tabela" Width="*" IsReadOnly="True"/>
                                    <DataGridTextColumn Binding="{Binding Tipo}" Header="Tipo" Width="100" IsReadOnly="True"/>
                                    <DataGridTextColumn Binding="{Binding EstimativaLinhas}" Header="Linhas (Est.)" Width="100" IsReadOnly="True"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                        
                        <TextBlock Text="{Binding TabelasDisponiveis.Count, StringFormat='Tabelas encontradas: {0}'}" 
                                   Margin="0,5,0,0" Foreground="Gray"/>
                    </StackPanel>

                    <StackPanel Visibility="{Binding PassoAtual, Converter={StaticResource PassoVisibilityConverter}, ConverterParameter=5}">
                        <TextBlock Text="Passo 5: Configurar Mapeamentos" FontSize="24" FontWeight="Bold" Margin="0,0,0,10"/>
                        
                        <Grid Height="400">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <ProgressBar IsIndeterminate="True" Height="4" 
                                         Visibility="{Binding CarregandoMapeamentos, Converter={StaticResource BooleanToVisibilityConverter}}"
                                         VerticalAlignment="Top"/>

                            <!-- Seleção da tabela para mapear -->
                            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,10">
                                <TextBlock Text="Tabela:" VerticalAlignment="Center" FontWeight="SemiBold" Margin="0,0,10,0"/>
                                <ComboBox ItemsSource="{Binding Mapeamentos}" 
                                          SelectedItem="{Binding MapeamentoSelecionado}"
                                          DisplayMemberPath="TabelaOrigem"
                                          Width="300"/>
                            </StackPanel>

                            <!-- Grid de colunas -->
                            <DataGrid Grid.Row="2" ItemsSource="{Binding MapeamentoSelecionado.Colunas}" 
                                      AutoGenerateColumns="False" CanUserAddRows="False"
                                      HeadersVisibility="Column" GridLinesVisibility="Horizontal"
                                      BorderThickness="1" BorderBrush="#DDDDDD">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Binding="{Binding ColunaOrigem}" Header="Origem" Width="*" IsReadOnly="True" Foreground="Gray"/>
                                    <DataGridTextColumn Binding="{Binding TipoOrigem}" Header="Tipo" Width="100" IsReadOnly="True" Foreground="Gray"/>
                                    
                                    <DataGridTemplateColumn Header="Ignorar" Width="60">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <CheckBox IsChecked="{Binding Ignorar, UpdateSourceTrigger=PropertyChanged}" 
                                                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTextColumn Binding="{Binding ColunaDestino}" Header="Coluna Destino (Para)" Width="*"/>
                                    <DataGridTextColumn Binding="{Binding TipoDestino}" Header="Tipo Destino" Width="100"/>
                                    
                                    <DataGridTemplateColumn Header="PK" Width="40">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <CheckBox IsChecked="{Binding ChavePrimaria, UpdateSourceTrigger=PropertyChanged}" 
                                                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>

                        <TextBlock Text="Selecione uma tabela acima e configure as colunas." 
                                   Margin="0,5,0,0" Foreground="Gray" FontStyle="Italic"/>
                    </StackPanel>

                    <StackPanel Visibility="{Binding PassoAtual, Converter={StaticResource PassoVisibilityConverter}, ConverterParameter=6}">
                        <TextBlock Text="Passo 6: Adicionar Regras de Transformação" FontSize="24" FontWeight="Bold" Margin="0,0,0,10"/>
                        
                        <!-- Seleção da tabela -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                            <TextBlock Text="Tabela:" VerticalAlignment="Center" FontWeight="SemiBold" Margin="0,0,10,0"/>
                            <ComboBox ItemsSource="{Binding Mapeamentos}" 
                                      SelectedItem="{Binding MapeamentoSelecionado}"
                                      DisplayMemberPath="TabelaOrigem"
                                      Width="300"/>
                        </StackPanel>

                        <Grid Height="350">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/> <!-- Lista de Colunas -->
                                <ColumnDefinition Width="1.5*"/> <!-- Regras da Coluna -->
                            </Grid.ColumnDefinitions>

                            <!-- Lista de Colunas -->
                            <Border Grid.Column="0" BorderBrush="#DDDDDD" BorderThickness="1" Margin="0,0,10,0">
                                <DataGrid ItemsSource="{Binding MapeamentoSelecionado.Colunas}" 
                                          SelectedItem="{Binding ColunaParaRegraSelecionada}"
                                          AutoGenerateColumns="False" CanUserAddRows="False"
                                          HeadersVisibility="Column" GridLinesVisibility="Horizontal"
                                          SelectionMode="Single">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Binding="{Binding ColunaDestino}" Header="Coluna Destino" Width="*"/>
                                        <DataGridTextColumn Binding="{Binding TipoDestino}" Header="Tipo" Width="80" IsReadOnly="True" Foreground="Gray"/>
                                        <DataGridTextColumn Binding="{Binding Regras.Count}" Header="Regras" Width="50" IsReadOnly="True"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </Border>

                            <!-- Painel de Regras -->
                            <Border Grid.Column="1" BorderBrush="#DDDDDD" BorderThickness="1" Padding="10">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/> <!-- Header -->
                                        <RowDefinition Height="Auto"/> <!-- Adicionar -->
                                        <RowDefinition Height="*"/>    <!-- Lista -->
                                    </Grid.RowDefinitions>

                                    <StackPanel Visibility="{Binding ColunaParaRegraSelecionada, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <TextBlock Text="{Binding ColunaParaRegraSelecionada.ColunaDestino, StringFormat='Regras para: {0}'}" 
                                                   FontSize="16" FontWeight="Bold" Margin="0,0,0,10"/>

                                        <!-- Adicionar Regra -->
                                        <GroupBox Header="Adicionar Nova Regra" Margin="0,0,0,10">
                                            <StackPanel Orientation="Horizontal" Margin="5">
                                                <ComboBox ItemsSource="{Binding RegrasDisponiveis}" 
                                                          SelectedItem="{Binding RegraSelecionadaParaAdicionar}"
                                                          Width="200" Margin="0,0,10,0"/>
                                                <Button Content="+ Adicionar" Command="{Binding AdicionarRegraCommand}" Width="80"/>
                                            </StackPanel>
                                        </GroupBox>

                                        <!-- Lista de Regras -->
                                        <TextBlock Text="Regras Aplicadas (em ordem):" FontWeight="SemiBold" Margin="0,0,0,5"/>
                                        <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="220">
                                            <ItemsControl ItemsSource="{Binding ColunaParaRegraSelecionada.Regras}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Background="#F9F9F9" BorderBrush="#EEEEEE" BorderThickness="1" Margin="0,0,0,5" Padding="5">
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                </Grid.ColumnDefinitions>
                                                                
                                                                <TextBlock Text="{Binding NomeExibicao}" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                                                
                                                                <TextBox Grid.Column="1" Text="{Binding Parametros, UpdateSourceTrigger=PropertyChanged}" 
                                                                         Tag="Parâmetros (ex: formato data, valor default)" 
                                                                         VerticalAlignment="Center" Margin="0,0,10,0"/>
                                                                
                                                                <Button Grid.Column="2" Content="❌" 
                                                                        Command="{Binding DataContext.RemoverRegraCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                                        CommandParameter="{Binding}"
                                                                        ToolTip="Remover Regra"
                                                                        Background="Transparent" BorderThickness="0" Foreground="Red"/>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </StackPanel>

                                    <TextBlock Text="Selecione uma coluna à esquerda para configurar regras." 
                                               Visibility="{Binding ColunaParaRegraSelecionada, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Inverse}"
                                               VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="Gray"/>
                                </Grid>
                            </Border>
                        </Grid>
                    </StackPanel>

                    <StackPanel Visibility="{Binding PassoAtual, Converter={StaticResource PassoVisibilityConverter}, ConverterParameter=7}">
                        <TextBlock Text="Passo 7: Revisão" FontSize="24" FontWeight="Bold"/>
                        <TextBlock Text="Resumo da configuração:" FontSize="16" Margin="0,20,0,10"/>
                        <Border Background="#F5F5F5" Padding="20" CornerRadius="4">
                            <StackPanel>
                                <TextBlock Text="{Binding NomeJob, StringFormat='Nome: {0}'}" Margin="0,5" FontWeight="Bold"/>
                                <Separator Margin="0,5,0,10"/>
                                <TextBlock Text="{Binding ConexaoOrigemSelecionada.Nome, StringFormat='Origem: {0}'}" Margin="0,5"/>
                                <TextBlock Text="{Binding ConexaoDestinoSelecionada.Nome, StringFormat='Destino: {0}'}" Margin="0,5"/>
                                <TextBlock Text="{Binding TamanhoLote, StringFormat='Tamanho Lote: {0} registros'}" Margin="0,5"/>
                                <TextBlock Text="{Binding Mapeamentos.Count, StringFormat='Tabelas Mapeadas: {0}'}" Margin="0,5" FontWeight="SemiBold"/>
                                <TextBlock Text="As configurações acima serão salvas ao clicar em Finalizar." Margin="0,20,0,0" FontStyle="Italic" Foreground="Gray"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </StackPanel>
            </Border>
        </ScrollViewer>

        <!-- Rodapé com Botões -->
        <Border Grid.Row="2" Background="White" Padding="40,20" BorderBrush="#DDDDDD" BorderThickness="0,1,0,0">
            <Grid>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                    <Button Content="Cancelar" Style="{StaticResource SecondaryButton}" 
                            Command="{Binding CancelarCommand}" Width="120"/>
                </StackPanel>
                
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="← Voltar" Style="{StaticResource SecondaryButton}" 
                            Command="{Binding VoltarCommand}"
                            IsEnabled="{Binding PodeVoltar}"
                            Width="120" Margin="0,0,10,0"/>
                    
                    <Button Content="Avançar →" Style="{StaticResource PrimaryButton}" 
                            Command="{Binding AvancarCommand}"
                            Visibility="{Binding PassoAtual, Converter={StaticResource NotEqualConverter}, ConverterParameter=7}"
                            Width="120"/>
                    
                    <Button Content="✓ Finalizar" Style="{StaticResource PrimaryButton}" 
                            Command="{Binding FinalizarCommand}"
                            Visibility="{Binding PassoAtual, Converter={StaticResource EqualConverter}, ConverterParameter=7}"
                            Width="120"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>


</Window>
